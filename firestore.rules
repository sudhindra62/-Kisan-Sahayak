/**
 * This Firestore Security Ruleset is designed for a farmer subsidy application.
 *
 * Core Philosophy:
 * The security model enforces a strict user-ownership paradigm and rigorous data
 * validation. All data created by a user is private and accessible only to that
 * user. Data is validated against a strict schema on the server-side before
 * any write operation, preventing malformed or malicious data injection.
 *
 * Data Structure & Security:
 * - User Isolation: Data is nested under `/users/{userId}`, isolating each user's data.
 * - Public Data is Read-Only: `/government_schemes` is readable by any authenticated
 *   user but is not writable from the client.
 * - Path and Data Consistency: Rules enforce that the document ID for user data
 *   must match the user's Auth UID and a corresponding `id` field within the
 *   document, making ownership explicit and immutable.
 * - Schema Validation: All `create` and `update` operations are validated against
 *   functions (e.g., `isValidFarmerProfile`) that enforce data types, required
 *   fields, and prevent extraneous fields, ensuring data integrity at the source.
 *
 * Denormalization for Authorization:
 * This ruleset relies on denormalization. Ownership is established directly
 * through the request path (`/users/{userId}/...`) and a denormalized `id` field
 * (`id: userId`) stored within each user-specific document. This makes authorization
 * checks self-contained, performant, and cost-effective.
 */
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------
    // Type and Schema Validation Helper Functions
    // --------------------------------------------------------------------
    
    function isString(value) {
      return value is string;
    }

    function isStringOrNull(value) {
      return value == null || value is string;
    }
    
    function isNumber(value) {
      return value is number;
    }

    function isTimestamp(value) {
      return value is timestamp;
    }

    function isValidFarmerProfile(data) {
      return data.keys().hasAll(['id', 'landSize', 'state', 'district', 'cropType', 'irrigationType', 'annualIncome', 'documentSetId'])
          && isString(data.id)
          && isNumber(data.landSize)
          && isString(data.state)
          && isString(data.district)
          && isString(data.cropType)
          && isString(data.irrigationType)
          && isNumber(data.annualIncome)
          && isString(data.documentSetId);
    }
    
    function isValidUploadedDocument(data) {
      return data.keys().hasAll(['id', 'landProofUrl', 'incomeCertificateUrl', 'identityProofUrl', 'uploadTimestamp', 'verificationStatus'])
          && isString(data.id)
          && isStringOrNull(data.landProofUrl)
          && isStringOrNull(data.incomeCertificateUrl)
          && isStringOrNull(data.identityProofUrl)
          && isTimestamp(data.uploadTimestamp)
          && isString(data.verificationStatus)
          && isStringOrNull(data.damagedCropImageUrl)
          && (data.containsKey('mismatchDetails') ? isString(data.mismatchDetails) : true);
    }
    
    function isValidChatHistory(data) {
       return data.keys().hasAll(['id', 'messages', 'updatedAt'])
           && data.keys().size() == 3
           && isString(data.id)
           && data.messages is list
           && isTimestamp(data.updatedAt)
           && (data.messages.size() == 0 || (
               data.messages[0].keys().hasAll(['role', 'content']) &&
               isString(data.messages[0].role) &&
               isString(data.messages[0].content)
             )
           );
    }

    // --------------------------------------------------------------------
    // Core Auth Helper Functions
    // --------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
    
    function hasValidCreationId(userId) {
      return request.resource.data.id == userId;
    }
    
    function hasImmutableId() {
      return request.resource.data.id == resource.data.id;
    }


    // --------------------------------------------------------------------
    // User Data Collections with Schema Validation
    // --------------------------------------------------------------------

    match /users/{userId} {
      allow read, write: if false;

      match /farmer_profile/{farmerProfileId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && farmerProfileId == userId 
                         && hasValidCreationId(userId) 
                         && isValidFarmerProfile(request.resource.data);
        allow update: if isExistingOwner(userId) && farmerProfileId == userId 
                         && hasImmutableId() 
                         && isValidFarmerProfile(request.resource.data);
        allow delete: if isExistingOwner(userId) && farmerProfileId == userId;
      }

      match /uploaded_documents/{uploadedDocumentId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && uploadedDocumentId == userId 
                         && hasValidCreationId(userId) 
                         && isValidUploadedDocument(request.resource.data);
        allow update: if isExistingOwner(userId) && uploadedDocumentId == userId 
                         && hasImmutableId() 
                         && isValidUploadedDocument(request.resource.data);
        allow delete: if isExistingOwner(userId) && uploadedDocumentId == userId;
      }
      
      match /chat_history/{chatId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && chatId == userId 
                         && hasValidCreationId(userId) 
                         && isValidChatHistory(request.resource.data);
        allow update: if isExistingOwner(userId) && chatId == userId 
                         && hasImmutableId() 
                         && isValidChatHistory(request.resource.data);
        allow delete: if isExistingOwner(userId) && chatId == userId;
      }
    }


    // --------------------------------------------------------------------
    // Public Data Collections
    // --------------------------------------------------------------------

    match /government_schemes/{schemeId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create, update, delete: if false;
    }
  }
}
